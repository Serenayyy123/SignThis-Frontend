<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Marketplace å–å®¶é¢æ¿</title>
    <script src="https://unpkg.com/ethers@6.7.0/dist/ethers.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px 0; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0 10px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .section { margin-top: 20px; padding: 15px; border: 1px dashed #ddd; border-radius: 6px; }
        #status { margin-top: 10px; font-weight: bold; color: blue; }
        .error { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h1>NFT Marketplace ä¸Šæ¶å·¥å…·</h1>
    
    <div class="section">
        <h2>1. é’±åŒ…è¿æ¥</h2>
        <button id="connectWalletBtn">è¿æ¥ MetaMask é’±åŒ…</button>
        <p id="accountInfo">çŠ¶æ€: æœªè¿æ¥</p>
        <p>
            **æ³¨æ„ï¼š** è¯·ç¡®ä¿æ‚¨çš„é’±åŒ…å·²åˆ‡æ¢åˆ°**åˆçº¦éƒ¨ç½²çš„ç½‘ç»œ** (ä¾‹å¦‚ Sepolia æµ‹è¯•ç½‘)ã€‚
        </p>
    </div>

    <div class="section">
        <h2>2. NFT äº¤æ˜“ä¿¡æ¯</h2>
        <p>NFT å¸‚åœºåˆçº¦åœ°å€: <strong style="color: purple;">0xd9145CCE52D386f254917e481eB44e9943F39138</strong></p>
        <p>NFT åˆçº¦åœ°å€: <strong id="nftAddressDisplay">0xF1eD68c6173717B084400F3FeC4A3FfecE7b48C7</strong></p>
        <p>Token ID: <strong id="tokenIdDisplay">1</strong></p>

        <label for="priceInput">ä»·æ ¼ (ETH):</label>
        <input type="text" id="priceInput" value="0.01">

        <label for="royaltyReceiverInput">ç‰ˆç¨æ¥æ”¶åœ°å€:</label>
        <input type="text" id="royaltyReceiverInput" placeholder="è¯·è¾“å…¥ç‰ˆç¨æ¥æ”¶åœ°å€" value="0x0000000000000000000000000000000000000000">

        <label for="royaltyPercentInput">ç‰ˆç¨ç™¾åˆ†æ¯” (åŸºç‚¹, 100 = 1%):</label>
        <input type="text" id="royaltyPercentInput" value="500" placeholder="ä¾‹å¦‚ 500">
    </div>

    <div class="section">
        <h2>3. æˆæƒä¸ä¸Šæ¶æ“ä½œ</h2>
        <button id="approveBtn" disabled>æˆæƒå¸‚åœºè½¬ç§» NFT</button>
        <button id="listBtn" disabled>ä¸Šæ¶ NFT åˆ°å¸‚åœº</button>
        <p id="status"></p>
    </div>
</div>

<script>
    // --- åˆçº¦é…ç½® ---
    const MARKETPLACE_ADDRESS = "0xd9145CCE52D386f254917e481eB44e9943F39138"; 
    const NFT_ADDRESS = "0xF1eD68c6173717B084400F3FeC4A3FfecE7b48C7";
    const TOKEN_ID = 1;
    
    // ç®€åŒ– ABI
    const ERC721_ABI = [
        "function setApprovalForAll(address operator, bool approved) public",
        "function isApprovedForAll(address owner, address operator) view returns (bool)",
    ];

    const MARKETPLACE_ABI = [
        "function listNFT(address nftAddress, uint256 tokenId, uint256 price, address royaltyReceiver, uint256 royaltyPercent) external"
    ];

    // --- å…¨å±€å˜é‡ ---
    let provider;
    let signer;
    let account;

    // --- DOM å…ƒç´  ---
    const accountInfo = document.getElementById('accountInfo');
    const statusDiv = document.getElementById('status');
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const approveBtn = document.getElementById('approveBtn');
    const listBtn = document.getElementById('listBtn');
    const priceInput = document.getElementById('priceInput');
    const royaltyReceiverInput = document.getElementById('royaltyReceiverInput');
    const royaltyPercentInput = document.getElementById('royaltyPercentInput');


    /**
     * æ›´æ–°çŠ¶æ€ä¿¡æ¯
     */
    function updateStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = isError ? 'error' : '';
    }

    /**
     * 1. ä¿®æ­£åçš„è¿æ¥é’±åŒ…åŠŸèƒ½
     */
    async function connectWallet() {
        // æ£€æŸ¥é’±åŒ…æä¾›è€… (MetaMask) æ˜¯å¦å­˜åœ¨
        if (!window.ethereum) {
            updateStatus("æœªæ£€æµ‹åˆ° MetaMaskã€‚è¯·å®‰è£…å®ƒæˆ–ä½¿ç”¨å…¼å®¹çš„æµè§ˆå™¨ã€‚", true);
            return;
        }

        try {
            updateStatus("æ­£åœ¨è¯·æ±‚è¿æ¥å’Œè´¦æˆ·æƒé™...");
            
            // å…³é”®æ­¥éª¤ï¼šè¯·æ±‚è´¦æˆ·æƒé™ã€‚Metamask å°†å¼¹å‡ºè¿æ¥çª—å£ã€‚
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

            if (accounts.length === 0) {
                 updateStatus("ç”¨æˆ·æ‹’ç»è¿æ¥æˆ–æœªé€‰æ‹©è´¦æˆ·ã€‚", true);
                 return;
            }

            // æˆåŠŸè·å–è´¦æˆ·åï¼Œåˆå§‹åŒ– ethers provider å’Œ signer
            provider = new ethers.BrowserProvider(window.ethereum);
            
            signer = await provider.getSigner();
            account = accounts[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªè¿æ¥çš„è´¦æˆ·

            accountInfo.innerHTML = `çŠ¶æ€: <span style="color: green;">å·²è¿æ¥</span> | åœ°å€: <strong>${account.substring(0, 6)}...${account.slice(-4)}</strong>`;
            updateStatus("è¿æ¥æˆåŠŸï¼è¯·æ£€æŸ¥ MetaMask ç¡®è®¤ç½‘ç»œã€‚");

            // è®¾ç½®ç‰ˆç¨æ¥æ”¶åœ°å€é»˜è®¤å€¼
            if (royaltyReceiverInput.value === "0x0000000000000000000000000000000000000000" || royaltyReceiverInput.value === "") {
                royaltyReceiverInput.value = account;
            }

            // å¯ç”¨åç»­æŒ‰é’®
            approveBtn.disabled = false;
            listBtn.disabled = false;
            connectWalletBtn.disabled = true;

            // ç›‘å¬è´¦æˆ·å˜åŒ–æˆ–ç½‘ç»œå˜åŒ–ï¼Œä¿æŒçŠ¶æ€åŒæ­¥
            window.ethereum.on('accountsChanged', handleAccountsChanged);
            window.ethereum.on('chainChanged', handleChainChanged);

        } catch (error) {
            console.error("è¿æ¥é’±åŒ…å¤±è´¥:", error);
            // å¤„ç†å¸¸è§çš„ç”¨æˆ·æ‹’ç»é”™è¯¯ (Error code 4001)
            if (error.code === 4001) {
                updateStatus("è¿æ¥è¢«ç”¨æˆ·æ‹’ç»ã€‚", true);
            } else {
                updateStatus(`è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}`, true);
            }
        }
    }

    /**
     * é’±åŒ…è´¦æˆ·å˜åŒ–å¤„ç†
     */
    function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
            alert('è´¦æˆ·å·²æ–­å¼€è¿æ¥ã€‚è¯·é‡æ–°è¿æ¥ã€‚');
            window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥é‡ç½®çŠ¶æ€
        } else if (account !== accounts[0]) {
            account = accounts[0];
            alert(`è´¦æˆ·å·²åˆ‡æ¢è‡³: ${account.substring(0, 6)}...`);
            window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°è´¦æˆ·
        }
    }

    /**
     * é’±åŒ…ç½‘ç»œå˜åŒ–å¤„ç†
     */
    function handleChainChanged(chainId) {
        alert(`ç½‘ç»œå·²åˆ‡æ¢è‡³ Chain ID: ${chainId}ã€‚è¯·ç¡®è®¤è¿™æ˜¯åˆçº¦éƒ¨ç½²çš„ç½‘ç»œã€‚`);
        window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥é‡æ–°åˆå§‹åŒ– provider
    }


    /**
     * 2. æˆæƒå¸‚åœºè½¬ç§» NFT
     */
    async function approveMarketplace() {
        if (!signer) {
            updateStatus("è¯·å…ˆè¿æ¥é’±åŒ…ã€‚", true);
            return;
        }

        try {
            updateStatus("æ­£åœ¨æ£€æŸ¥æˆæƒçŠ¶æ€...");
            
            const nftContractView = new ethers.Contract(NFT_ADDRESS, ERC721_ABI, provider);
            const isApproved = await nftContractView.isApprovedForAll(account, MARKETPLACE_ADDRESS);
            
            if (isApproved) {
                updateStatus("å¸‚åœºå·²è·å¾—æˆæƒ (setApprovalForAll)ï¼Œæ— éœ€é‡å¤æ“ä½œã€‚");
                return;
            }

            updateStatus("å¸‚åœºæœªæˆæƒã€‚æ­£åœ¨åˆ›å»ºæˆæƒäº¤æ˜“...");
            const nftContract = new ethers.Contract(NFT_ADDRESS, ERC721_ABI, signer);
            
            const tx = await nftContract.setApprovalForAll(MARKETPLACE_ADDRESS, true);
            
            updateStatus(`äº¤æ˜“å·²å‘é€ (${tx.hash.substring(0, 6)}...)ï¼Œè¯·ç­‰å¾…ç¡®è®¤...`);
            
            await tx.wait();
            
            updateStatus("âœ… æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥ä¸Šæ¶ NFT äº†ã€‚");

        } catch (error) {
            console.error("æˆæƒå¤±è´¥:", error);
            updateStatus(`æˆæƒå¤±è´¥: ${error.message || "äº¤æ˜“è¢«æ‹’ç»æˆ–å‘ç”Ÿé”™è¯¯ã€‚"}`, true);
        }
    }

    /**
     * 3. ä¸Šæ¶ NFT
     */
    async function listNFT() {
        if (!signer) {
            updateStatus("è¯·å…ˆè¿æ¥é’±åŒ…ã€‚", true);
            return;
        }

        const priceEth = priceInput.value;
        const royaltyReceiver = royaltyReceiverInput.value;
        const royaltyPercent = royaltyPercentInput.value;

        if (parseFloat(priceEth) <= 0 || !ethers.isAddress(royaltyReceiver) || isNaN(parseInt(royaltyPercent))) {
            updateStatus("è¯·ç¡®ä¿ä»·æ ¼å¤§äº0ï¼Œç‰ˆç¨æ¥æ”¶åœ°å€æœ‰æ•ˆï¼Œå¹¶å¡«å†™æ­£ç¡®çš„ç‰ˆç¨ç™¾åˆ†æ¯”ã€‚", true);
            return;
        }

        try {
            updateStatus("æ­£åœ¨åˆ›å»ºä¸Šæ¶äº¤æ˜“...");

            const priceWei = ethers.parseEther(priceEth); // å°† ETH è½¬æ¢ä¸º Wei
            const percentBasisPoints = BigInt(royaltyPercent);

            const marketplaceContract = new ethers.Contract(MARKETPLACE_ADDRESS, MARKETPLACE_ABI, signer);

            const tx = await marketplaceContract.listNFT(
                NFT_ADDRESS,
                TOKEN_ID,
                priceWei,
                royaltyReceiver,
                percentBasisPoints
            );

            updateStatus(`ä¸Šæ¶äº¤æ˜“å·²å‘é€ (${tx.hash.substring(0, 6)}...)ï¼Œè¯·ç­‰å¾…ç¡®è®¤...`);

            await tx.wait();

            updateStatus("ğŸ‰ NFT ä¸Šæ¶æˆåŠŸï¼", false);
            
        } catch (error) {
            console.error("ä¸Šæ¶å¤±è´¥:", error);
            let errorMessage = "äº¤æ˜“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆæƒã€NFTæ‰€æœ‰æƒæˆ–åˆçº¦è¦æ±‚ã€‚";
            if (error.reason) {
                 errorMessage = `ä¸Šæ¶å¤±è´¥: ${error.reason}`;
            } else if (error.message && error.message.includes('insufficient funds')) {
                 errorMessage = "äº¤æ˜“å¤±è´¥ï¼šè´¦æˆ· ETH ä¸è¶³æ”¯ä»˜ Gas è´¹ã€‚";
            } else if (error.message && error.message.includes('user rejected transaction')) {
                 errorMessage = "äº¤æ˜“è¢«ç”¨æˆ·æ‹’ç»ã€‚";
            }
            updateStatus(errorMessage, true);
        }
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ ---
    connectWalletBtn.addEventListener('click', connectWallet);
    approveBtn.addEventListener('click', approveMarketplace);
    listBtn.addEventListener('click', listNFT);

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        document.getElementById('nftAddressDisplay').textContent = NFT_ADDRESS;
        document.getElementById('tokenIdDisplay').textContent = TOKEN_ID;
    };
</script>

</body>
</html>