  <!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamask ç»„ç»‡è€…ç­¾åˆ°ç³»ç»Ÿ (SignThis)</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        /* (æ ·å¼ä¸ä¹‹å‰ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç©ºé—´) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #007bff; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 25px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .result-box { background: #e9ecef; padding: 15px; border-radius: 4px; margin-top: 20px; word-break: break-all; }
        #connectedAddress { font-weight: bold; color: green; }
        #log { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
    </style>
</head>
<body>

<div class="container">
    <h1>Metamask æˆæƒç­¾åˆ°ç³»ç»Ÿ</h1>
    
    <div id="log" class="warning" style="display: block;">
        <strong>é‡è¦æç¤º:</strong> è¿è¡Œåœ¨ Sepolia ç½‘ç»œã€‚è¯·ä½¿ç”¨ **Metamask** æˆ–å…¶ä»–å…¼å®¹ **EVM** çš„æµè§ˆå™¨æ’ä»¶é’±åŒ…ï¼Œå¹¶ç¡®ä¿åˆ‡æ¢åˆ°éƒ¨ç½²åˆçº¦çš„ **ç»„ç»‡è€…åœ°å€**ã€‚
    </div>
    
    <h2>é’±åŒ…çŠ¶æ€</h2>
    <p>è¿æ¥åœ°å€: <span id="connectedAddress">æœªè¿æ¥</span></p>
    <button onclick="connectWallet()">è¿æ¥ Web3 é’±åŒ… (ä¾‹å¦‚ Metamask)</button>
    
    <hr>

    <h2>é…ç½®ä¸æ“ä½œ</h2>
    <label for="contractAddress">åˆçº¦åœ°å€ (Sepolia)</label>
    <input type="text" id="contractAddress" placeholder="è¾“å…¥å·²éƒ¨ç½²çš„ SignThis åˆçº¦åœ°å€ (0x...)" value="">

    <label for="eventName">äº‹ä»¶åç§° (å¿…é¡»ä¸åˆçº¦æ„é€ å‡½æ•°ä¸€è‡´)</label>
    <input type="text" id="eventName" placeholder="ä¾‹å¦‚: Web3 Conference 2024" value="">
    
    <label for="attendeeAddress">ç›®æ ‡ç­¾åˆ°åœ°å€ (å‚ä¸è€…åœ°å€)</label>
    <input type="text" id="attendeeAddress" placeholder="è¾“å…¥å‚ä¸è€…åœ°å€ (0x...)">

    <button onclick="signAndCheckIn()">ğŸš€ ä¸€é”®ç­¾åå¹¶ç­¾åˆ°</button>
    
    <div id="dynamicLog" class="info" style="display: none;"></div>
</div>

<script>
    // åˆçº¦ ABI (åªåŒ…å«éœ€è¦ç”¨åˆ°çš„å‡½æ•°)
    const contractABI = [
        "function checkInWithSignature(address attendee, uint8 v, bytes32 r, bytes32 s) external",
        "function organizer() external view returns (address)", // ç”¨äºè·å–ç»„ç»‡è€…åœ°å€
    ];

    let provider;
    let signer;
    const sepoliaChainId = '0xaa36a7'; // Sepolia chain ID

    // --- è¾…åŠ©å‡½æ•° ---
    // (æ—¥å¿—å’Œè¾“å…¥å‡½æ•°ä¸ V1 ä¿æŒä¸€è‡´)
    function logMessage(message, type = 'info') {
        const log = document.getElementById('dynamicLog');
        log.style.display = 'block';
        log.className = type; 
        log.innerHTML = `<p><strong>${type.toUpperCase()}:</strong> ${message}</p>` + log.innerHTML;
    }

    function clearLog() {
        document.getElementById('dynamicLog').innerHTML = '';
        document.getElementById('dynamicLog').style.display = 'none';
    }

    function getInputs() {
        const contractAddress = document.getElementById('contractAddress').value.trim();
        const eventName = document.getElementById('eventName').value.trim();
        const attendeeAddress = document.getElementById('attendeeAddress').value.trim();
        return { contractAddress, eventName, attendeeAddress };
    }
    
    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè¿æ¥é’±åŒ… (ä¼˜åŒ–äº†è¿æ¥é€»è¾‘) ---

    async function connectWallet() {
        clearLog();
        document.getElementById('connectedAddress').textContent = 'è¿æ¥ä¸­...';

        if (typeof window.ethereum === 'undefined') {
            document.getElementById('connectedAddress').textContent = 'æœªå®‰è£…æ’ä»¶';
            return logMessage("âŒ æµè§ˆå™¨ä¸­æœªæ£€æµ‹åˆ° Web3 é’±åŒ… (window.ethereum)ã€‚è¯·å®‰è£… Metamask ç­‰æ’ä»¶ã€‚", 'error');
        }

        try {
            // è¯·æ±‚è¿æ¥é’±åŒ…
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            
            const connectedAddr = await signer.getAddress();
            document.getElementById('connectedAddress').textContent = connectedAddr;
            
            // æ£€æŸ¥ç½‘ç»œæ˜¯å¦ä¸º Sepolia
            const network = await provider.getNetwork();
            if (network.chainId !== 11155111) { // 11155111 æ˜¯ Sepolia çš„ ChainID
                 logMessage(`âš ï¸ å½“å‰ç½‘ç»œä¸æ˜¯ Sepolia (Chain ID: ${network.chainId})ã€‚è¯·åœ¨é’±åŒ…ä¸­åˆ‡æ¢åˆ° Sepoliaã€‚`, 'warning');
            } else {
                 logMessage(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€: ${connectedAddr}ã€‚ç½‘ç»œ: Sepoliaã€‚`, 'success');
            }


            // ç›‘å¬ Metamask è´¦æˆ·æˆ–ç½‘ç»œå˜åŒ–ï¼Œå˜åŒ–æ—¶åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½çŠ¶æ€
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());

        } catch (error) {
            console.error(error);
            document.getElementById('connectedAddress').textContent = 'è¿æ¥å¤±è´¥';
            logMessage(`âŒ è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}. è¯·æ£€æŸ¥ Metamask æ˜¯å¦è§£é”æˆ–æ‹’ç»äº†è¿æ¥ã€‚`, 'error');
        }
    }

    // --- æ ¸å¿ƒæ“ä½œï¼šç­¾åå¹¶ç­¾åˆ° ---

    async function signAndCheckIn() {
        clearLog();
        if (!signer) {
            return logMessage("âŒ è¯·å…ˆç‚¹å‡» 'è¿æ¥ Web3 é’±åŒ…' å¹¶ç¡®ä¿è¿æ¥æˆåŠŸã€‚", 'error');
        }

        try {
            const { contractAddress, eventName, attendeeAddress } = getInputs();
            
            // åŸºç¡€è¾“å…¥éªŒè¯
            if (!contractAddress || !eventName || !attendeeAddress) {
                return logMessage("è¯·å¡«å†™æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚", 'error');
            }
            if (!ethers.utils.isAddress(attendeeAddress)) {
                return logMessage("æ— æ•ˆçš„å‚ä¸è€…åœ°å€ã€‚", 'error');
            }

            // 1. æ£€æŸ¥è¿æ¥çš„é’±åŒ…æ˜¯å¦æ˜¯ç»„ç»‡è€…
            const contract = new ethers.Contract(contractAddress, contractABI, provider);
            const requiredOrganizer = await contract.organizer();
            const currentSignerAddress = await signer.getAddress();

            if (currentSignerAddress.toLowerCase() !== requiredOrganizer.toLowerCase()) {
                return logMessage(`âš ï¸ é’±åŒ…åœ°å€ä¸æ˜¯ç»„ç»‡è€…ï¼åˆçº¦ç»„ç»‡è€…åœ°å€: ${requiredOrganizer}ã€‚è¯·åœ¨é’±åŒ…ä¸­åˆ‡æ¢åˆ°è¯¥åœ°å€ã€‚`, 'error');
            }
            logMessage(`è¿æ¥çš„åœ°å€ (${currentSignerAddress}) ç¡®è®¤ä¸ºåˆçº¦ç»„ç»‡è€…ã€‚ç»§ç»­ç­¾å...`, 'info');


            // 2. æ„é€ æ¶ˆæ¯å“ˆå¸Œ (ä¸Solidityåˆçº¦ä¸­çš„messageHashä¸€è‡´)
            const messageHash = ethers.utils.solidityKeccak256(
                ['address', 'address', 'string'],
                [attendeeAddress, contractAddress, eventName]
            );

            // 3. Metamask ç­¾å
            logMessage("ç­‰å¾…é’±åŒ…ç­¾åæˆæƒã€‚è¯·åœ¨æ‚¨çš„é’±åŒ…ä¸­ç¡®è®¤ç­¾åè¯·æ±‚...", 'warning');
            const signature = await signer.signMessage(
                ethers.utils.arrayify(messageHash)
            );

            // 4. åˆ†ç¦»ç­¾åç»„ä»¶
            const { v, r, s } = ethers.utils.splitSignature(signature);
            logMessage("âœ… ç­¾åæˆåŠŸï¼ç°åœ¨å‘é€ç­¾åˆ°äº¤æ˜“ã€‚", 'success');


            // 5. æäº¤ç­¾åˆ°äº¤æ˜“ (ç»„ç»‡è€…æ”¯ä»˜Gas)
            const contractWithSigner = contract.connect(signer);
            logMessage("ç­‰å¾…é’±åŒ…äº¤æ˜“ç¡®è®¤ã€‚è¯·åœ¨æ‚¨çš„é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...", 'warning');

            const tx = await contractWithSigner.checkInWithSignature(
                attendeeAddress,
                v,
                r,
                s
            );

            logMessage(`ç­‰å¾…äº¤æ˜“ç¡®è®¤ (Hash: ${tx.hash})...`, 'warning');
            
            // 6. ç­‰å¾…äº¤æ˜“å®Œæˆ
            const receipt = await tx.wait();
            logMessage(`ğŸ‰ ç­¾åˆ°æˆåŠŸï¼äº¤æ˜“å·²ç¡®è®¤ã€‚äº¤æ˜“åœ°å€: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a>`, 'success');

        } catch (error) {
            console.error(error);
            logMessage(`âŒ ç­¾åˆ°å¤±è´¥: ${error.message || error.code || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨å°è¯•è¿æ¥é’±åŒ…
    document.addEventListener('DOMContentLoaded', connectWallet);
</script>
</body>
</html>