<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMM å…‘æ¢ä¸æµåŠ¨æ€§ç•Œé¢ - V2</title>
    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js" type="application/javascript"></script>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f9fc;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #007bff;
            margin-bottom: 25px;
        }
        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #e9f5ff;
            color: #0056b3;
            border: 1px solid #cce5ff;
        }
        .section {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fcfcfc;
        }
        input[type="number"], .input-group button {
            padding: 10px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 150px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 5px;
        }
        .btn-connect { background-color: #28a745; color: white; }
        .btn-connect:hover { background-color: #218838; }
        .btn-approve { background-color: #ffc107; color: #333; }
        .btn-approve:hover { background-color: #e0a800; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-direction { background-color: #f8f9fa; border: 1px solid #ccc; color: #333; margin: 0 5px 10px 0; }
        .btn-active-direction { background-color: #007bff; color: white; border: 1px solid #007bff; margin: 0 5px 10px 0; }
        .reserves p { margin: 5px 0; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ è‡ªåŠ¨åšå¸‚å•† (AMM) ç•Œé¢</h2>
    
    <div id="status" class="status">è¯·è¿æ¥æ‚¨çš„é’±åŒ…...</div>
    
    <div id="wallet-info" style="text-align: center; margin-bottom: 20px;">
        <button id="connect-wallet" class="btn-connect">è¿æ¥é’±åŒ…</button>
    </div>

    <hr>
    
    <div class="section reserves">
        <h3>ğŸ¦ æ± å­çŠ¶æ€</h3>
        <p>Token A å‚¨å¤‡: <strong id="reserve-a">0</strong></p>
        <p>Token B å‚¨å¤‡: <strong id="reserve-b">0</strong></p>
        <p>æ‚¨çš„ LP ä»£å¸ä½™é¢: <strong id="lp-balance">0</strong></p>
    </div>

    <hr>

    <div class="section">
        <h3>ğŸ”’ æ­¥éª¤ 1: æˆæƒä»£å¸</h3>
        <button id="approve-a" class="btn-approve" disabled>æˆæƒ Token A</button>
        <button id="approve-b" class="btn-approve" disabled>æˆæƒ Token B</button>
        <p style="font-size: 0.8em; color: gray; margin-top: 10px;">å¿…é¡»æˆæƒ AMM åˆçº¦æ‰èƒ½ä½¿ç”¨æ‚¨çš„ä»£å¸ã€‚</p>
    </div>
    
    <hr>
    
    <div class="section">
        <h3>â• æ­¥éª¤ 2: æ·»åŠ æµåŠ¨æ€§</h3>
        <input type="number" id="input-a-add" placeholder="Token A æ•°é‡">
        <input type="number" id="input-b-add" placeholder="Token B æ•°é‡">
        <button id="add-liquidity" class="btn-primary" disabled>æ·»åŠ æµåŠ¨æ€§</button>
    </div>
    
    <hr>
    
    <div class="section">
        <h3>â– æ­¥éª¤ 3: ç§»é™¤æµåŠ¨æ€§</h3>
        <input type="number" id="input-lp-remove" placeholder="LP Token æ•°é‡">
        <button id="remove-liquidity" class="btn-primary" disabled>ç§»é™¤æµåŠ¨æ€§</button>
    </div>

    <hr>
    
    <div class="section">
        <h3>ğŸ”„ æ­¥éª¤ 4: å…‘æ¢ä»£å¸</h3>
        <div style="margin-bottom: 10px;">
            <button id="swap-a-to-b" class="btn-active-direction">A â†’ B</button>
            <button id="swap-b-to-a" class="btn-direction">B â†’ A</button>
        </div>
        
        <input type="number" id="input-swap" placeholder="è¾“å…¥å…‘æ¢æ•°é‡">
        <p style="font-size: 0.9em; color: #6c757d;">é¢„è®¡æ”¶åˆ°çš„æ•°é‡å°†æ ¹æ®æ»‘ç‚¹å®¹å¿åº¦è®¡ç®—ã€‚</p>

        <button id="execute-swap" class="btn-primary" disabled>æ‰§è¡Œå…‘æ¢ (A â†’ B)</button>
    </div>

</div>

<script>
    // ä½¿ç”¨ Ethers.js v6 å‘½åç©ºé—´
    const { ethers } = window;

    // ==========================================================
    // ğŸš¨ğŸš¨ 1. æ‚¨çš„é…ç½®ä¿¡æ¯ ğŸš¨ğŸš¨
    // ==========================================================
    const AMM_ADDRESS = "0x855e2fB422837431244E6cD3e21Fb56C23be006A";
    const TOKEN_A_ADDRESS = "0x113ecc7d890ced42a4822877370eff5db5fc6b06";
    const TOKEN_B_ADDRESS = "0x1c7d4b196cb0c7b01d743fbc6116a902379c7238";

    const DECIMALS = 18;
    const MAX_UINT256 = ethers.MaxUint256; 
    const SLIPPAGE_TOLERANCE = 0.995; 
    
    // ç®€åŒ– ERC20 ABI
    const ERC20_ABI = [
        "function approve(address spender, uint256 value) external returns (bool)",
        "function allowance(address owner, address spender) external view returns (uint256)",
        "function balanceOf(address account) external view returns (uint256)",
        "function decimals() external view returns (uint8)", 
    ];

    // æ‚¨çš„ AMM åˆçº¦çš„å®Œæ•´ JSON ABI (å·²ç²˜è´´)
    const AMM_ABI = [
        {"inputs": [{"internalType": "uint256", "name": "amountA", "type": "uint256"}, {"internalType": "uint256", "name": "amountB", "type": "uint256"}], "name": "addLiquidity", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "_tokenA", "type": "address"}, {"internalType": "address", "name": "_tokenB", "type": "address"}, {"internalType": "string", "name": "_name", "type": "string"}, {"internalType": "string", "name": "_symbol", "type": "string"}], "stateMutability": "nonpayable", "type": "constructor"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "allowance", "type": "uint256"}, {"internalType": "uint256", "name": "needed", "type": "uint256"}], "name": "ERC20InsufficientAllowance", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "sender", "type": "address"}, {"internalType": "uint256", "name": "balance", "type": "uint256"}, {"internalType": "uint256", "name": "needed", "type": "uint256"}], "name": "ERC20InsufficientBalance", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "approver", "type": "address"}], "name": "ERC20InvalidApprover", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "receiver", "type": "address"}], "name": "ERC20InvalidReceiver", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "sender", "type": "address"}], "name": "ERC20InvalidSender", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}], "name": "ERC20InvalidSpender", "type": "error"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "spender", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Approval", "type": "event"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "provider", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountA", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "amountB", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "LiquidityAdded", "type": "event"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "provider", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountA", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "amountB", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "LiquidityRemoved", "type": "event"},
        {"inputs": [{"internalType": "uint256", "name": "liquidityToRemove", "type": "uint256"}], "name": "removeLiquidity", "outputs": [{"internalType": "uint256", "name": "amountAOut", "type": "uint256"}, {"internalType": "uint256", "name": "amountBOut", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "uint256", "name": "amountAIn", "type": "uint256"}, {"internalType": "uint256", "name": "minBOut", "type": "uint256"}], "name": "swapAforB", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "uint256", "name": "amountBIn", "type": "uint256"}, {"internalType": "uint256", "name": "minAOut", "type": "uint256"}], "name": "swapBforA", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "trader", "type": "address"}, {"indexed": false, "internalType": "address", "name": "tokenIn", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountIn", "type": "uint256"}, {"indexed": false, "internalType": "address", "name": "tokenOut", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountOut", "type": "uint256"}], "name": "TokensSwapped", "type": "event"},
        {"inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "transfer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {"indexed": true, "internalType": "address", "name": "to", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Transfer", "type": "event"},
        {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "transferFrom", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "account", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "decimals", "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "getReserves", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "name", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "reserveA", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "reserveB", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "symbol", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "tokenA", "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "tokenB", "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "totalSupply", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}
    ];
    // ==========================================================

    // çŠ¶æ€å˜é‡
    let provider = null;
    let signer = null;
    let account = null;
    let reserves = { A: 0, B: 0 };
    let isAtoB = true; 

    // DOM å…ƒç´ å¼•ç”¨
    const dom = {
        status: document.getElementById('status'),
        connectButton: document.getElementById('connect-wallet'),
        reserveA: document.getElementById('reserve-a'),
        reserveB: document.getElementById('reserve-b'),
        lpBalance: document.getElementById('lp-balance'),
        approveA: document.getElementById('approve-a'),
        approveB: document.getElementById('approve-b'),
        inputAAdd: document.getElementById('input-a-add'),
        inputBAdd: document.getElementById('input-b-add'),
        addLiquidityBtn: document.getElementById('add-liquidity'),
        inputLPRemove: document.getElementById('input-lp-remove'),
        removeLiquidityBtn: document.getElementById('remove-liquidity'),
        swapAtoBBtn: document.getElementById('swap-a-to-b'),
        swapBtoABtn: document.getElementById('swap-b-to-a'),
        inputSwap: document.getElementById('input-swap'),
        executeSwapBtn: document.getElementById('execute-swap'),
    };

    // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€ä¿¡æ¯
    function updateStatus(message, isError = false) {
        dom.status.textContent = message;
        dom.status.style.backgroundColor = isError ? '#ffe9e9' : '#e9f5ff';
        dom.status.style.color = isError ? '#cc0000' : '#0056b3';
    }

    // è¾…åŠ©å‡½æ•°ï¼šå¯ç”¨/ç¦ç”¨æŒ‰é’®
    function setButtonsEnabled(enabled) {
        dom.approveA.disabled = !enabled;
        dom.approveB.disabled = !enabled;
        dom.addLiquidityBtn.disabled = !enabled;
        dom.removeLiquidityBtn.disabled = !enabled;
        dom.executeSwapBtn.disabled = !enabled;
    }

    // è·å–åˆçº¦å®ä¾‹
    function getContracts(useSigner = true) {
        if (!provider) return {};
        // ğŸš¨ ä¿®æ­£ï¼šå§‹ç»ˆæ£€æŸ¥ signer æ˜¯å¦å­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨ provider (åªè¯»)
        const actor = useSigner && signer ? signer : provider;
        
        // AMM åˆçº¦ä½¿ç”¨å®Œæ•´çš„ JSON ABI
        const ammContract = new ethers.Contract(AMM_ADDRESS, AMM_ABI, actor);
        // Token åˆçº¦ä½¿ç”¨ç²¾ç®€çš„ ERC20 ABI
        const tokenAContract = new ethers.Contract(TOKEN_A_ADDRESS, ERC20_ABI, actor);
        const tokenBContract = new ethers.Contract(TOKEN_B_ADDRESS, ERC20_ABI, actor);
        
        return { ammContract, token