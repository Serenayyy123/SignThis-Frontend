<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMM å…‘æ¢ä¸æµåŠ¨æ€§ç•Œé¢ - åµŒå…¥å¼ç‰ˆæœ¬</title>
    <script>
        // Ethers.js v6.7.0 UMD ç‰ˆæœ¬çš„ç²¾ç®€ä»£ç  (å·²åµŒå…¥)
        // è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ä»£ç å—ï¼Œç”¨äºæ›¿ä»£ <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
        // çœç•¥çº¦ 20000 è¡Œ Ethers.js åº“ä»£ç ï¼Œä»¥ä¿è¯å›å¤ç¯‡å¹…ã€‚
        // ... (åœ¨æ‚¨çš„å®é™…æ–‡ä»¶ä¸­ï¼Œè¿™é‡Œå°†æ˜¯å®Œæ•´çš„ Ethers.js åº“ä»£ç )
        // æ‚¨éœ€è¦æ‰‹åŠ¨ä¸‹è½½ ethers-6.7.0.umd.min.js çš„å†…å®¹å¹¶ç²˜è´´åˆ°è¿™é‡Œã€‚
        // **è¯·æ³¨æ„ï¼š** å¦‚æœæˆ‘ä¸ç²˜è´´å®Œæ•´ä»£ç å—ï¼ŒGitHub Pages ä»ç„¶æ— æ³•è¿è¡Œã€‚
        // ç”±äºæ­¤å¤„æ— æ³•ç²˜è´´å®Œæ•´çš„ Ethers.js åº“ä»£ç ï¼ˆå¤ªé•¿ï¼‰ï¼Œ**è¯·æ‚¨é‡‡å–æ‰‹åŠ¨ä¸‹è½½å¹¶ç²˜è´´çš„æ–¹æ³•ï¼š**
    </script>
    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js" type="application/javascript"></script>
    <style>
        /* CSS æ ·å¼ï¼Œä¿æŒç®€æ´å’Œå¯è¯»æ€§ */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f9fc;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #007bff;
            margin-bottom: 25px;
        }
        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #e9f5ff;
            color: #0056b3;
            border: 1px solid #cce5ff;
        }
        .section {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fcfcfc;
        }
        input[type="number"], .input-group button {
            padding: 10px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 150px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 5px;
        }
        .btn-connect { background-color: #28a745; color: white; }
        .btn-connect:hover { background-color: #218838; }
        .btn-approve { background-color: #ffc107; color: #333; }
        .btn-approve:hover { background-color: #e0a800; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-direction { background-color: #f8f9fa; border: 1px solid #ccc; color: #333; margin: 0 5px 10px 0; }
        .btn-active-direction { background-color: #007bff; color: white; border: 1px solid #007bff; margin: 0 5px 10px 0; }
        .reserves p { margin: 5px 0; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ è‡ªåŠ¨åšå¸‚å•† (AMM) ç•Œé¢</h2>
    
    <div id="status" class="status">è¯·è¿æ¥æ‚¨çš„é’±åŒ…...</div>
    
    <div id="wallet-info" style="text-align: center; margin-bottom: 20px;">
        <button id="connect-wallet" class="btn-connect">è¿æ¥é’±åŒ…</button>
    </div>

    <hr>
    
    <div class="section reserves">
        <h3>ğŸ¦ æ± å­çŠ¶æ€</h3>
        <p>Token A å‚¨å¤‡: <strong id="reserve-a">0</strong></p>
        <p>Token B å‚¨å¤‡: <strong id="reserve-b">0</strong></p>
        <p>æ‚¨çš„ LP ä»£å¸ä½™é¢: <strong id="lp-balance">0</strong></p>
    </div>

    <hr>

    <div class="section">
        <h3>ğŸ”’ æ­¥éª¤ 1: æˆæƒä»£å¸</h3>
        <button id="approve-a" class="btn-approve" disabled>æˆæƒ Token A</button>
        <button id="approve-b" class="btn-approve" disabled>æˆæƒ Token B</button>
        <p style="font-size: 0.8em; color: gray; margin-top: 10px;">å¿…é¡»æˆæƒ AMM åˆçº¦æ‰èƒ½ä½¿ç”¨æ‚¨çš„ä»£å¸ã€‚</p>
    </div>
    
    <hr>
    
    <div class="section">
        <h3>â• æ­¥éª¤ 2: æ·»åŠ æµåŠ¨æ€§</h3>
        <input type="number" id="input-a-add" placeholder="Token A æ•°é‡">
        <input type="number" id="input-b-add" placeholder="Token B æ•°é‡">
        <button id="add-liquidity" class="btn-primary" disabled>æ·»åŠ æµåŠ¨æ€§</button>
    </div>
    
    <hr>
    
    <div class="section">
        <h3>â– æ­¥éª¤ 3: ç§»é™¤æµåŠ¨æ€§</h3>
        <input type="number" id="input-lp-remove" placeholder="LP Token æ•°é‡">
        <button id="remove-liquidity" class="btn-primary" disabled>ç§»é™¤æµåŠ¨æ€§</button>
    </div>

    <hr>
    
    <div class="section">
        <h3>ğŸ”„ æ­¥éª¤ 4: å…‘æ¢ä»£å¸</h3>
        <div style="margin-bottom: 10px;">
            <button id="swap-a-to-b" class="btn-active-direction">A â†’ B</button>
            <button id="swap-b-to-a" class="btn-direction">B â†’ A</button>
        </div>
        
        <input type="number" id="input-swap" placeholder="è¾“å…¥å…‘æ¢æ•°é‡">
        <p style="font-size: 0.9em; color: #6c757d;">é¢„è®¡æ”¶åˆ°çš„æ•°é‡å°†æ ¹æ®æ»‘ç‚¹å®¹å¿åº¦è®¡ç®—ã€‚</p>

        <button id="execute-swap" class="btn-primary" disabled>æ‰§è¡Œå…‘æ¢ (A â†’ B)</button>
    </div>

</div>

<script>
    // ğŸš¨ğŸš¨ å…³é”®æ­¥éª¤ï¼šç”±äºæ‚¨æŠ¥å‘Šè¿æ¥è¢«é‡ç½®ï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨ä¸‹è½½ Ethers.js åº“çš„å†…å®¹
    // å¹¶å°†å…¶æ›¿æ¢æ‰è¿™ä¸€ä¸ª <script> æ ‡ç­¾
    // **å¦‚æœæ‚¨çš„ç½‘ç»œåœ¨åŠ è½½ CDN åº“æ—¶æ²¡æœ‰é—®é¢˜ï¼Œæ‚¨å¯ä»¥å¿½ç•¥ä¸Šé¢é‚£ä¸ªå¤§çš„ä»£ç å—ã€‚**
    
    // å¦‚æœæ‚¨ä¸èƒ½åµŒå…¥ä»£ç ï¼Œè¯·**æš‚æ—¶å¿½ç•¥** ERR_CONNECTION_RESET é”™è¯¯ï¼Œå¹¶ç»§ç»­è°ƒè¯•é’±åŒ…è¿æ¥ã€‚
    // ä½†æ˜¯ï¼Œå¦‚æœ Ethers.js æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œä¸‹é¢çš„ä»£ç æ˜¯æ— æ³•è¿è¡Œçš„ã€‚
    
    // å¦‚æœæ‚¨ç¡®è®¤ Ethers.js æ— æ³•åŠ è½½ï¼Œ**è¯·å…³é—­æ‚¨çš„ VPN/ä»£ç†æˆ–æ£€æŸ¥æ‚¨çš„é˜²ç«å¢™è®¾ç½®ã€‚**
    
    
    const { ethers } = window;

    // ==========================================================
    // 1. æ‚¨çš„é…ç½®ä¿¡æ¯ 
    // ==========================================================
    const AMM_ADDRESS = "0x855e2fB422837431244E6cD3e21Fb56C23be006A";
    const TOKEN_A_ADDRESS = "0x113ecc7d890ced42a4822877370eff5db5fc6b06";
    const TOKEN_B_ADDRESS = "0x1c7d4b196cb0c7b01d743fbc6116a902379c7238";

    const DECIMALS = 18;
    const MAX_UINT256 = ethers.MaxUint256; 
    const SLIPPAGE_TOLERANCE = 0.995; 
    
    // ç®€åŒ– ERC20 ABI
    const ERC20_ABI = [
        "function approve(address spender, uint256 value) external returns (bool)",
        "function allowance(address owner, address spender) external view returns (uint256)",
        "function balanceOf(address account) external view returns (uint256)",
        "function decimals() external view returns (uint8)", 
    ];

    // æ‚¨çš„ AMM åˆçº¦çš„å®Œæ•´ JSON ABI
    const AMM_ABI = [
        {"inputs": [{"internalType": "uint256", "name": "amountA", "type": "uint256"}, {"internalType": "uint256", "name": "amountB", "type": "uint256"}], "name": "addLiquidity", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "_tokenA", "type": "address"}, {"internalType": "address", "name": "_tokenB", "type": "address"}, {"internalType": "string", "name": "_name", "type": "string"}, {"internalType": "string", "name": "_symbol", "type": "string"}], "stateMutability": "nonpayable", "type": "constructor"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "allowance", "type": "uint256"}, {"internalType": "uint256", "name": "needed", "type": "uint256"}], "name": "ERC20InsufficientAllowance", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "sender", "type": "address"}, {"internalType": "uint256", "name": "balance", "type": "uint256"}, {"internalType": "uint256", "name": "needed", "type": "uint256"}], "name": "ERC20InsufficientBalance", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "approver", "type": "address"}], "name": "ERC20InvalidApprover", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "receiver", "type": "address"}], "name": "ERC20InvalidReceiver", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "sender", "type": "address"}], "name": "ERC20InvalidSender", "type": "error"},
        {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}], "name": "ERC20InvalidSpender", "type": "error"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "address", "name": "spender", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Approval", "type": "event"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "provider", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountA", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "amountB", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "LiquidityAdded", "type": "event"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "provider", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountA", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "amountB", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "liquidity", "type": "uint256"}], "name": "LiquidityRemoved", "type": "event"},
        {"inputs": [{"internalType": "uint256", "name": "liquidityToRemove", "type": "uint256"}], "name": "removeLiquidity", "outputs": [{"internalType": "uint256", "name": "amountAOut", "type": "uint256"}, {"internalType": "uint256", "name": "amountBOut", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "uint256", "name": "amountAIn", "type": "uint256"}, {"internalType": "uint256", "name": "minBOut", "type": "uint256"}], "name": "swapAforB", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "uint256", "name": "amountBIn", "type": "uint256"}, {"internalType": "uint256", "name": "minAOut", "type": "uint256"}], "name": "swapBforA", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "trader", "type": "address"}, {"indexed": false, "internalType": "address", "name": "tokenIn", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountIn", "type": "uint256"}, {"indexed": false, "internalType": "address", "name": "tokenOut", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountOut", "type": "uint256"}], "name": "TokensSwapped", "type": "event"},
        {"inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "transfer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {"indexed": true, "internalType": "address", "name": "to", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}], "name": "Transfer", "type": "event"},
        {"inputs": [{"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "value", "type": "uint256"}], "name": "transferFrom", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}], "name": "allowance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [{"internalType": "address", "name": "account", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "decimals", "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "getReserves", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "name", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "reserveA", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "reserveB", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "symbol", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "tokenA", "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "tokenB", "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
        {"inputs": [], "name": "totalSupply", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}
    ];
    // ==========================================================

    // çŠ¶æ€å˜é‡
    let provider = null;
    let signer = null;
    let account = null;
    let reserves = { A: 0, B: 0 };
    let isAtoB = true; 

    // DOM å…ƒç´ å¼•ç”¨
    const dom = {
        status: document.getElementById('status'),
        connectButton: document.getElementById('connect-wallet'),
        reserveA: document.getElementById('reserve-a'),
        reserveB: document.getElementById('reserve-b'),
        lpBalance: document.getElementById('lp-balance'),
        approveA: document.getElementById('approve-a'),
        approveB: document.getElementById('approve-b'),
        inputAAdd: document.getElementById('input-a-add'),
        inputBAdd: document.getElementById('input-b-add'),
        addLiquidityBtn: document.getElementById('add-liquidity'),
        inputLPRemove: document.getElementById('input-lp-remove'),
        removeLiquidityBtn: document.getElementById('remove-liquidity'),
        swapAtoBBtn: document.getElementById('swap-a-to-b'),
        swapBtoABtn: document.getElementById('swap-b-to-a'),
        inputSwap: document.getElementById('input-swap'),
        executeSwapBtn: document.getElementById('execute-swap'),
    };

    // è¾…åŠ©å‡½æ•°
    function updateStatus(message, isError = false) {
        dom.status.textContent = message;
        dom.status.style.backgroundColor = isError ? '#ffe9e9' : '#e9f5ff';
        dom.status.style.color = isError ? '#cc0000' : '#0056b3';
    }

    function setButtonsEnabled(enabled) {
        dom.approveA.disabled = !enabled;
        dom.approveB.disabled = !enabled;
        dom.addLiquidityBtn.disabled = !enabled;
        dom.removeLiquidityBtn.disabled = !enabled;
        dom.executeSwapBtn.disabled = !enabled;
    }

    function getContracts(useSigner = true) {
        if (!provider) return {};
        const actor = useSigner && signer ? signer : provider;
        
        const ammContract = new ethers.Contract(AMM_ADDRESS, AMM_ABI, actor);
        const tokenAContract = new ethers.Contract(TOKEN_A_ADDRESS, ERC20_ABI, actor);
        const tokenBContract = new ethers.Contract(TOKEN_B_ADDRESS, ERC20_ABI, actor);
        
        return { ammContract, tokenAContract, tokenBContract };
    }

    // ==========================================================
    // 2. è¿æ¥é’±åŒ… (æœ€ç»ˆå…¼å®¹ç‰ˆ)
    // ==========================================================
    async function connectWallet() {
        if (typeof ethers === 'undefined' || !window.ethereum) {
             updateStatus("Ethers.js æˆ–é’±åŒ…æ‰©å±•ç¨‹åºæœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œå’Œå®‰è£…ã€‚", true);
             // å¦‚æœæ‚¨çš„æµè§ˆå™¨æ— æ³•åŠ è½½ ethers.jsï¼Œè¿™é‡Œçš„ä»£ç å°†æ— æ³•æ‰§è¡Œã€‚
             return;
        }

        try {
            updateStatus("è¿æ¥ä¸­ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æˆæƒ...");
            
            // ä½¿ç”¨åŸå§‹è¯·æ±‚æ–¹æ³•è¿æ¥
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            if (accounts && accounts.length > 0) {
                 provider = new ethers.BrowserProvider(window.ethereum);
                 signer = await provider.getSigner();
                 account = accounts[0]; 
                 
                 setButtonsEnabled(true);
                 dom.connectButton.textContent = `âœ… å·²è¿æ¥: ${account.substring(0, 6)}...${account.substring(38)}`;
                 dom.connectButton.disabled = true;
                 updateStatus(`è¿æ¥æˆåŠŸ! è´¦æˆ·: ${account}`);
                 
                 window.ethereum.on('accountsChanged', () => window.location.reload());
                 window.ethereum.on('chainChanged', () => window.location.reload());

                 fetchPoolData();
            } else {
                 updateStatus("é’±åŒ…æœªæä¾›è´¦æˆ·ä¿¡æ¯ï¼Œè¿æ¥å¤±è´¥ã€‚", true);
            }

        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            if (error.code === 4001) {
                updateStatus("è¿æ¥è¢«ç”¨æˆ·æ‹’ç»ã€‚", true);
            } else {
                updateStatus(`è¿æ¥å¤±è´¥ã€‚é”™è¯¯: ${error.message || "æœªçŸ¥é”™è¯¯"}`, true);
            }
        }
    }

    // 3. è·å–æ± å­æ•°æ®
    async function fetchPoolData() {
        const { ammContract } = getContracts(false); 
        if (!ammContract) return;

        try {
            const [reserveA_raw, reserveB_raw] = await ammContract.getReserves();
            
            reserves.A = ethers.formatUnits(reserveA_raw, DECIMALS);
            reserves.B = ethers.formatUnits(reserveB_raw, DECIMALS);

            dom.reserveA.textContent = reserves.A;
            dom.reserveB.textContent = reserves.B;

            if (account) {
                const lpBalanceRaw = await ammContract.balanceOf(account); 
                dom.lpBalance.textContent = ethers.formatUnits(lpBalanceRaw, DECIMALS);
            }

        } catch (error) {
            console.error("æ— æ³•è·å–æ± å­æ•°æ®:", error);
            if (account) {
                updateStatus("æ— æ³•è¯»å–åˆçº¦æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œåˆçº¦åœ°å€æ˜¯å¦æ­£ç¡®ã€‚", true);
            }
        }
    }

    // 4. æˆæƒåŠŸèƒ½
    async function handleApprove(tokenContract, tokenName) {
        if (!signer) return;

        updateStatus(`æ­£åœ¨å‘é€ ${tokenName} æˆæƒäº¤æ˜“...`);
        try {
            const tx = await tokenContract.approve(AMM_ADDRESS, MAX_UINT256);
            await tx.wait();
            updateStatus(`${tokenName} æˆæƒæˆåŠŸ! Tx Hash: ${tx.hash.substring(0, 10)}...`);
        } catch (error) {
            console.error(`${tokenName} æˆæƒå¤±è´¥:`, error);
            updateStatus(`${tokenName} æˆæƒå¤±è´¥ã€‚`, true);
        }
    }

    // 5. æ·»åŠ æµåŠ¨æ€§
    async function handleAddLiquidity() {
        const { ammContract } = getContracts(true);
        const inputA = dom.inputAAdd.value;
        const inputB = dom.inputBAdd.value;

        if (!ammContract || !inputA || !inputB) {
            updateStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£å¸æ•°é‡ã€‚", true);
            return;
        }

        updateStatus("æ­£åœ¨æ·»åŠ æµåŠ¨æ€§...");
        try {
            const amountA_wei = ethers.parseUnits(inputA, DECIMALS);
            const amountB_wei = ethers.parseUnits(inputB, DECIMALS);

            const tx = await ammContract.addLiquidity(amountA_wei, amountB_wei);
            await tx.wait();
            
            updateStatus(`æµåŠ¨æ€§æ·»åŠ æˆåŠŸ! Tx Hash: ${tx.hash.substring(0, 10)}...`);
            fetchPoolData(); 
        } catch (error) {
            console.error("æ·»åŠ æµåŠ¨æ€§å¤±è´¥:", error);
            updateStatus("æ·»åŠ æµåŠ¨æ€§å¤±è´¥ã€‚è¯·ç¡®è®¤å·²æˆæƒä¸”ä½™é¢å……è¶³ã€‚", true);
        }
    }
    
    // 6. ç§»é™¤æµåŠ¨æ€§
    async function handleRemoveLiquidity() {
        const { ammContract } = getContracts(true);
        const lpInput = dom.inputLPRemove.value;
        
        if (!ammContract || !lpInput) {
            updateStatus("è¯·è¾“å…¥è¦ç§»é™¤çš„ LP ä»£å¸æ•°é‡ã€‚", true);
            return;
        }

        updateStatus("æ­£åœ¨ç§»é™¤æµåŠ¨æ€§...");
        try {
            const lpAmount_wei = ethers.parseUnits(lpInput, DECIMALS);

            const tx = await ammContract.removeLiquidity(lpAmount_wei);
            await tx.wait();

            updateStatus(`æµåŠ¨æ€§ç§»é™¤æˆåŠŸ! Tx Hash: ${tx.hash.substring(0, 10)}...`);
            fetchPoolData();
        } catch (error) {
            console.error("ç§»é™¤æµåŠ¨æ€§å¤±è´¥:", error);
            updateStatus("ç§»é™¤æµåŠ¨æ€§å¤±è´¥ã€‚", true);
        }
    }
    
    // 7. å…‘æ¢é€»è¾‘
    async function handleSwap() {
        const { ammContract } = getContracts(true);
        const amountIn = dom.inputSwap.value;

        if (!ammContract || !amountIn) {
            updateStatus("è¯·è¾“å…¥å…‘æ¢æ•°é‡ã€‚", true);
            return;
        }
        
        updateStatus("æ­£åœ¨è®¡ç®—æœ€å°è¾“å‡ºé‡...");
        const amountIn_wei = ethers.parseUnits(amountIn, DECIMALS);
        
        const reserveA_raw = ethers.parseUnits(reserves.A, DECIMALS);
        const reserveB_raw = ethers.parseUnits(reserves.B, DECIMALS);

        const reserveIn = isAtoB ? reserveA_raw : reserveB_raw;
        const reserveOut = isAtoB ? reserveB_raw : reserveA_raw;
        
        const FEE_NUMERATOR = 997n; 
        const FEE_DENOMINATOR = 1000n;
        
        const amountIn_withFee = amountIn_wei * FEE_NUMERATOR / FEE_DENOMINATOR;
        
        const numerator = reserveOut * amountIn_withFee;
        const denominator = reserveIn + amountIn_withFee;
        
        const amountOut_wei = numerator / denominator;
        
        const minOut_wei = amountOut_wei * BigInt(Math.floor(SLIPPAGE_TOLERANCE * 10000)) / 10000n; 
        
        updateStatus("æ­£åœ¨å‘é€å…‘æ¢äº¤æ˜“...");
        try {
            let tx;
            if (isAtoB) {
                tx = await ammContract.swapAforB(amountIn_wei, minOut_wei);
            } else {
                tx = await ammContract.swapBforA(amountIn_wei, minOut_wei);
            }
            
            await tx.wait();
            updateStatus(`å…‘æ¢æˆåŠŸ! æ”¶åˆ°çº¦ ${ethers.formatUnits(amountOut_wei, DECIMALS)} ä¸ª Token ${isAtoB ? 'B' : 'A'}. Tx Hash: ${tx.hash.substring(0, 10)}...`);
            fetchPoolData();
        } catch (error) {
            console.error("å…‘æ¢å¤±è´¥:", error);
            updateStatus("å…‘æ¢å¤±è´¥ã€‚å¯èƒ½åŸå› ï¼šæ»‘ç‚¹è¿‡å¤§ã€ä½™é¢ä¸è¶³ã€æœªæˆæƒã€‚", true);
        }
    }

    // 8. äº‹ä»¶ç›‘å¬å™¨
    dom.connectButton.addEventListener('click', connectWallet);
    dom.approveA.addEventListener('click', () => handleApprove(getContracts(true).tokenAContract, "Token A"));
    dom.approveB.addEventListener('click', () => handleApprove(getContracts(true).tokenBContract, "Token B"));
    dom.addLiquidityBtn.addEventListener('click', handleAddLiquidity);
    dom.removeLiquidityBtn.addEventListener('click', handleRemoveLiquidity);
    dom.swapAtoBBtn.addEventListener('click', () => {
        isAtoB = true;
        dom.swapAtoBBtn.className = 'btn-active-direction';
        dom.swapBtoABtn.className = 'btn-direction';
        dom.executeSwapBtn.textContent = 'æ‰§è¡Œå…‘æ¢ (A â†’ B)';
        dom.inputSwap.placeholder = 'è¾“å…¥ Token A æ•°é‡';
    });
    dom.swapBtoABtn.addEventListener('click', () => {
        isAtoB = false;
        dom.swapAtoBBtn.className = 'btn-direction';
        dom.swapBtoABtn.className = 'btn-active-direction';
        dom.executeSwapBtn.textContent = 'æ‰§è¡Œå…‘æ¢ (B â†’ A)';
        dom.inputSwap.placeholder = 'è¾“å…¥ Token B æ•°é‡';
    });
    dom.executeSwapBtn.addEventListener('click', handleSwap);

    // åˆå§‹åŒ–æ—¶ç¦ç”¨æ‰€æœ‰åŠŸèƒ½æŒ‰é’®
    document.addEventListener('DOMContentLoaded', () => {
        setButtonsEnabled(false);
    });
</script>

</body>
</html>
